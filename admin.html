<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin • MobileBanking.legit</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <meta name="csrf-token" content="<%= csrfToken %>">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/">MobileBanking.legit</a>
    <span class="navbar-text text-light">Admin</span>
  </div>
</nav>

<div class="container my-4">
  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Users</h5>
          <div id="users"></div>
        </div>
      </div>
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <h5 class="card-title">Loans</h5>
          <div id="loans"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Pending Transfers</h5>
          <div id="pending"></div>
        </div>
      </div>
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <h5 class="card-title">Notifications</h5>
          <div id="notifs" class="small"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

async function fetchJSON(url, options={}) {
  const res = await fetch(url, Object.assign({ headers: { 'Content-Type':'application/json', 'CSRF-Token': csrfToken }}, options));
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

async function loadUsers() {
  const data = await fetchJSON('/api/admin/users');
  const box = document.getElementById('users');
  box.innerHTML = data.users.map(u => `
    <div class="border rounded p-2 mb-2 d-flex justify-content-between align-items-center">
      <div>
        <div class="fw-bold">${u.full_name} <small class="text-muted">(${u.email})</small></div>
        <div class="small text-muted">Balance: $${(u.balance_cents/100).toFixed(2)}</div>
      </div>
      <div class="d-flex gap-2">
        <input class="form-control form-control-sm" type="number" step="0.01" id="delta-${u.id}" placeholder="+/-">
        <button class="btn btn-sm btn-outline-primary" onclick="adjust(${u.id})">Apply</button>
      </div>
    </div>`).join('');
}

async function adjust(id) {
  const val = document.getElementById('delta-'+id).value;
  if (!val) return;
  await fetchJSON('/api/admin/users/'+id+'/balance', { method: 'PATCH', body: JSON.stringify({ delta: val }) });
  await loadUsers();
}

async function loadPending() {
  const data = await fetchJSON('/api/admin/transactions?status=pending');
  const box = document.getElementById('pending');
  box.innerHTML = data.transactions.map(t => `
    <div class="border rounded p-2 mb-2">
      <div><strong>#${t.id}</strong> $${(t.amount_cents/100).toFixed(2)} ${t.currency} • user ${t.user_id}</div>
      <div class="mt-2 d-flex gap-2">
        <button class="btn btn-sm btn-success" onclick="act(${t.id}, 'approve')">Approve</button>
        <button class="btn btn-sm btn-danger" onclick="act(${t.id}, 'reject')">Fail</button>
        <button class="btn btn-sm btn-warning" onclick="act(${t.id}, 'reverse')">Reverse</button>
      </div>
    </div>`).join('') || '<div class="text-muted">No pending transfers.</div>';
}

async function act(id, action) {
  await fetchJSON('/api/admin/transactions/'+id+'/'+action, { method: 'POST' });
  await loadPending();
}

async function loadLoans() {
  const data = await fetchJSON('/api/admin/loans');
  const box = document.getElementById('loans');
  box.innerHTML = data.loans.map(l => `
    <div class="border rounded p-2 mb-2 d-flex justify-content-between">
      <div>#${l.id} • user ${l.user_id} • $${(l.principal_cents/100).toFixed(2)} ${l.currency} • ${l.term_months}m @ ${l.apr}% • <span class="badge text-bg-secondary">${l.status}</span></div>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-success" onclick="loan(${l.id}, 'approve')">Approve</button>
        <button class="btn btn-sm btn-danger" onclick="loan(${l.id}, 'reject')">Reject</button>
      </div>
    </div>`).join('') || '<div class="text-muted">No loan requests.</div>';
}

async function loan(id, action) {
  await fetchJSON('/api/admin/loans/'+id+'/'+action, { method: 'POST' });
  await loadLoans();
}

async function loadNotifs() {
  const data = await fetchJSON('/api/notifications');
  const box = document.getElementById('notifs');
  box.innerHTML = data.notifications.map(n => `<div>[${n.created_at}] ${n.type.toUpperCase()}: ${n.message}</div>`).join('');
}

async function init() {
  await loadUsers();
  await loadPending();
  await loadLoans();
  await loadNotifs();
}
init();
</script>
</body>
</html>
